{% extends "base.html" %}
{% block title %}Creator Dashboard - CreatiLink
<!-- Delete Project Modal -->
<div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
        <h3 class="text-xl font-bold mb-4">🗑️ Delete Project?</h3>
        <p class="text-gray-600 mb-4">Are you sure you want to delete <strong id="deleteProjectName"></strong>?</p>
        <input type="text" id="deleteReason" placeholder="Reason for deletion (optional)" 
               class="w-full px-4 py-2 border rounded mb-4">
        <div class="flex gap-3">
            <button onclick="closeDeleteModal()" class="flex-1 px-4 py-2 border rounded hover:bg-gray-50">Cancel</button>
            <button onclick="confirmDelete()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
        </div>
    </div>
</div>

<!-- Leave Project Modal -->
<div id="leaveModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
        <h3 class="text-xl font-bold mb-4">👋 Leave Project?</h3>
        <p class="text-gray-600 mb-4">Customer will be notified. Project: <strong id="leaveProjectName"></strong></p>
        <input type="text" id="leaveReason" placeholder="Reason for leaving (optional)" 
               class="w-full px-4 py-2 border rounded mb-4">
        <div class="flex gap-3">
            <button onclick="closeLeaveModal()" class="flex-1 px-4 py-2 border rounded hover:bg-gray-50">Cancel</button>
            <button onclick="confirmLeave()" class="flex-1 px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700">Leave</button>
        </div>
    </div>
</div>


<!-- Dispute Modal -->
<div id="disputeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
        <h3 class="text-xl font-bold mb-4">⚠️ Raise Dispute</h3>
        <form id="disputeForm">
            <div class="mb-4">
                <label class="block text-sm font-semibold mb-2">Dispute Type</label>
                <select id="disputeType" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500" required>
                    <option value="">Select type...</option>
                    <option value="payment_not_received">Payment Not Received</option>
                    <option value="wrong_amount">Wrong Amount</option>
                    <option value="quality_issue">Quality Issue</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-semibold mb-2">Description</label>
                <textarea id="disputeDescription" 
                          rows="4" 
                          placeholder="Describe the issue in detail..." 
                          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500" 
                          required></textarea>
            </div>
            <div class="bg-yellow-50 border border-yellow-200 rounded p-3 mb-4">
                <p class="text-xs text-yellow-800">
                    <i class="fas fa-info-circle mr-1"></i>
                    Admin will review this dispute and contact both parties. Please provide accurate details.
                </p>
            </div>
            <div class="flex gap-3">
                <button type="button" onclick="closeDisputeModal()" 
                        class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                <button type="submit" 
                        class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Submit Dispute</button>
            </div>
        </form>
    </div>
</div>

<script>
let currentDisputeTransactionId = null;

function openDisputeModal(transactionId) {
    currentDisputeTransactionId = transactionId;
    document.getElementById('disputeModal').classList.remove('hidden');
}

function closeDisputeModal() {
    document.getElementById('disputeModal').classList.add('hidden');
    document.getElementById('disputeForm').reset();
    currentDisputeTransactionId = null;
}

document.getElementById('disputeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const type = document.getElementById('disputeType').value;
    const description = document.getElementById('disputeDescription').value;
    
    if (!type || !description) {
        alert('Please fill all fields');
        return;
    }
    
    fetch(`/dispute/create/${currentDisputeTransactionId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: new URLSearchParams({type: type, description: description})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert('⚠️ Dispute raised successfully. Admin will review.');
            closeDisputeModal();
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to raise dispute'));
        }
    })
    .catch(err => {
        alert('Error raising dispute');
        console.error(err);
    });
});
</script>

{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto px-4 py-12">
    <h1 class="text-3xl font-bold mb-8">Creator Dashboard</h1>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="text-3xl font-bold text-indigo-600">{{ active_jobs|length }}</div>
            <div class="text-gray-600">Active Jobs</div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="text-3xl font-bold text-green-600">{{ completed_jobs }}</div>
            <div class="text-gray-600">Completed</div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="text-3xl font-bold text-blue-600">{{ pending_applications }}</div>
            <div class="text-gray-600">Pending Applications</div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="text-3xl font-bold text-purple-600">&#8377;{{ "%.2f"|format(total_earnings) }}</div>
            <div class="text-gray-600">Total Earnings</div>
        </div>
    </div>

    <!-- Earnings Stats Row -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div
            class="bg-gradient-to-r from-yellow-50 to-yellow-100 rounded-lg shadow-lg p-6 border-l-4 border-yellow-500">
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-sm font-medium text-yellow-600 uppercase mb-1">
                        <i class="fas fa-clock mr-1"></i> Pending Earnings
                    </div>
                    <div class="text-3xl font-bold text-yellow-700">&#8377;{{ "%.2f"|format(pending_earnings) }}</div>
                    <div class="text-sm text-yellow-600 mt-1">Awaiting project completion</div>
                </div>
                <div class="text-yellow-400">
                    <i class="fas fa-coins text-5xl"></i>
                </div>
            </div>
        </div>
        <div
            class="bg-gradient-to-r from-emerald-50 to-emerald-100 rounded-lg shadow-lg p-6 border-l-4 border-em erald-500">
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-sm font-medium text-emerald-600 uppercase mb-1">
                        <i class="fas fa-check-circle mr-1"></i> Available Balance
                    </div>
                    <div class="text-3xl font-bold text-emerald-700">&#8377;{{ "%.2f"|format(total_earnings) }}</div>
                    <div class="text-sm text-emerald-600 mt-1">Ready to withdraw</div>
                </div>
                <div class="text-emerald-400">
                    <i class="fas fa-wallet text-5xl"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white rounded-xl shadow-lg p-8">
            <h2 class="text-2xl font-bold mb-6">Active Jobs</h2>
            {% for job in active_jobs %}
            <div class="border-b py-4">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h3 class="font-bold">{{ job.title }}</h3>
                        <p class="text-gray-600 text-sm">{{ job.customer.full_name }}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="leaveProject({{ job.id }}, '{{ job.title }}')" 
                                class="text-orange-600 hover:text-orange-800 p-1" 
                                title="Leave Project">
                            <i class="fas fa-sign-out-alt text-sm"></i>
                        </button>
                        <button onclick="deleteProject({{ job.id }}, '{{ job.title }}')" 
                                class="text-red-600 hover:text-red-800 p-1" 
                                title="Delete Project">
                            <i class="fas fa-trash-alt text-sm"></i>
                        </button>
                        <button onclick="deleteProject({{ job.id }}, '{{ job.title }}')" 
                                class="text-red-600 hover:text-red-800 p-1" 
                                title="Delete Project">
                            <i class="fas fa-trash-alt text-sm"></i>
                        </button>
                    </div>
                </div>
                    <span
                        class="bg-{{ 'blue' if job.status == 'assigned' else 'green' }}-100 text-{{ 'blue' if job.status == 'assigned' else 'green' }}-800 px-3 py-1 rounded-full text-xs">
                        {{ job.status|title }}
                    </span>
                </div>
                <div class="mt-3 flex flex-wrap gap-2">
                    <a href="{{ url_for('projects.detail', project_id=job.id) }}"
                        class="bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700">
                        <i class="fas fa-eye mr-1"></i> View
                    </a>
                    <a href="{{ url_for('chat.room', project_id=job.id) }}"
                        class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                        <i class="fas fa-comments mr-1"></i> Chat
                    </a>

                    {% if job.status == 'assigned' %}
                    <button onclick="openDeliveryModal({{ job.id }}, '{{ job.title }}')"
                        class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                        <i class="fas fa-cloud-upload-alt mr-1"></i> Submit Delivery
                    </button>
                    {% elif job.status == 'delivered' %}
                    <div class="bg-yellow-50 text-yellow-800 px-3 py-1 rounded text-sm">
                        <i class="fas fa-check-circle mr-1"></i> Delivered - Awaiting approval
                    </div>
                    {% endif %}
                </div>
                <!-- Payment Status for Delivered Jobs -->
                {% if job.status == 'delivered' %}
                {% set transaction = job_transactions.get(job.id) %}
                {% if transaction %}
                <div class="mt-3 border-t pt-3">
                    <div class="text-xs font-semibold text-gray-600 mb-2">💰 Payment Status</div>

                    {% if transaction.customer_confirmed and not transaction.creator_confirmed %}
                    <div class="bg-yellow-50 border border-yellow-200 rounded p-2">
                        <div class="text-yellow-700 text-sm font-semibold mb-1">🟡 Customer Paid &#8377;{{
                            transaction.amount }}</div>
                        <p class="text-xs text-yellow-600 mb-2">Check your UPI app and confirm</p>
                        {% if transaction.payment_screenshot %}
                        <div class="mt-2">
                            <a href="/static/{{ transaction.payment_screenshot }}" 
                               target="_blank" 
                               class="text-blue-600 hover:text-blue-800 text-xs inline-flex items-center">
                                <i class="fas fa-image mr-1"></i> View Payment Screenshot
                            </a>
                        </div>
                        {% endif %}
                        <div class="flex gap-2">
                            <button onclick="confirmReceipt({{ transaction.id }})"
                                class="flex-1 bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700 text-xs">✓
                                Received</button>
                            <button onclick="rejectPayment({{ transaction.id }})"
                                class="flex-1 bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700 text-xs">✗ Not
                                Received</button>
                        
                        <div class="mt-2">
                            <button onclick="openDisputeModal({{ transaction.id }})" 
                                    class="text-red-600 hover:text-red-800 text-xs inline-flex items-center">
                                <i class="fas fa-exclamation-triangle mr-1"></i> Raise Dispute
                            </button>
                        </div>
</div>
                    </div>
                    {% elif transaction.creator_confirmed %}
                    <div class="bg-green-50 border border-green-200 rounded p-2">
                        <div class="text-green-700 text-sm font-semibold">✅ Received: &#8377;{{ transaction.amount }}
                        </div>
                    </div>
                    {% else %}
                    <div class="bg-gray-50 border border-gray-200 rounded p-2">
                        <div class="text-gray-700 text-sm">⚪ Awaiting Payment (&#8377;{{ transaction.amount }})</div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                {% endif %}
            </div>
            {% else %}
            <p class="text-gray-500 text-center py-8">No active jobs</p>
            {% endfor %}
        </div>

        <div class="bg-white rounded-xl shadow-lg p-8">
            <h2 class="text-2xl font-bold mb-6">Recent Applications</h2>
            {% for app in applications %}
            <div class="border-b py-4">
                <h3 class="font-bold">{{ app.project.title }}</h3>
                <div class="flex justify-between text-sm mt-2">
                    <span class="text-gray-600">Quote: &#8377;{{ app.quote }}</span>
                    <span
                        class="bg-{{ 'green' if app.status == 'accepted' else 'yellow' if app.status == 'pending' else 'red' }}-100 text-{{ 'green' if app.status == 'accepted' else 'yellow' if app.status == 'pending' else 'red' }}-800 px-2 py-1 rounded text-xs">
                        {{ app.status|title }}
                    </span>
                </div>
            </div>
            {% else %}
            <p class="text-gray-500 text-center py-8">No applications yet</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Delivery Modal -->
<div id="deliveryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-8">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold">Submit Project Delivery</h3>
            <button onclick="closeDeliveryModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>

        <div id="modalProjectTitle" class="mb-6 text-gray-600"></div>

        <form id="deliveryForm" class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2">
                    Delivery Link <span class="text-red-500">*</span>
                </label>
                <input type="url" id="deliveryLink" required
                    placeholder="https://drive.google.com/... or Dropbox/OneDrive link"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <p class="text-xs text-gray-500 mt-1">
                    <i class="fas fa-info-circle mr-1"></i>
                    Upload your files to Google Drive, Dropbox, or OneDrive, then paste the sharing link here
                </p>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-2">
                    Delivery Note (Optional)
                </label>
                <textarea id="deliveryNote" rows="4" placeholder="Add a message for the customer about the delivery..."
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>

            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <p class="text-sm text-blue-800">
                    <i class="fas fa-lightbulb mr-2"></i>
                    <strong>Tips for successful delivery:</strong>
                </p>
                <ul class="text-sm text-blue-700 mt-2 ml-6 list-disc space-y-1">
                    <li>Ensure sharing permissions are set to "Anyone with the link can view"</li>
                    <li>Organize files in clearly labeled folders</li>
                    <li>Include source files if applicable</li>
                    <li>Test the link before submitting</li>
                </ul>
            </div>

            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" onclick="closeDeliveryModal()"
                    class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                    Cancel
                </button>
                <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    <i class="fas fa-paper-plane mr-2"></i>
                    Submit Delivery
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    let currentProjectId = null;

    function openDeliveryModal(projectId, projectTitle) {
        currentProjectId = projectId;
        document.getElementById('modalProjectTitle').innerHTML = `<strong>Project:</strong> ${projectTitle}`;
        document.getElementById('deliveryModal').classList.remove('hidden');
        document.getElementById('deliveryLink').value = '';
        document.getElementById('deliveryNote').value = '';
    }

    function closeDeliveryModal() {
        document.getElementById('deliveryModal').classList.add('hidden');
        currentProjectId = null;
    }

    document.getElementById('deliveryForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const link = document.getElementById('deliveryLink').value.trim();
        const note = document.getElementById('deliveryNote').value.trim();

        if (!link) {
            alert('Please provide a delivery link');
            return;
        }

        // Validate link domain
        const allowedDomains = ['drive.google.com', 'dropbox.com', 'onedrive.live.com', '1drv.ms'];
        const isValidDomain = allowedDomains.some(domain => link.toLowerCase().includes(domain));

        if (!isValidDomain) {
            alert('Please use Google Drive, Dropbox, or OneDrive links only');
            return;
        }

        // Submit delivery
        fetch(`/projects/${currentProjectId}/submit_delivery`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                delivery_link: link,
                delivery_note: note
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeDeliveryModal();
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while submitting delivery');
            });
    });

    // Close modal on background click
    document.getElementById('deliveryModal').addEventListener('click', function (e) {
        if (e.target === this) {
            closeDeliveryModal();
        }
    });

    async function confirmReceipt(id) {
        if (!confirm('Received payment in UPI app?')) return;
        const res = await fetch(`/payment/creator_confirm/${id}`, { method: 'POST' });
        if (res.ok) { alert('✅ Payment confirmed!'); location.reload(); }
    }

    async function rejectPayment(id) {
        if (!confirm('Mark as NOT received?')) return;
        const res = await fetch(`/payment/creator_reject/${id}`, { method: 'POST' });
        if (res.ok) { alert('❌ Customer notified'); location.reload(); }
    }

// Project Management Functions
let currentProjectId = null;

function deleteProject(id, title) {
    currentProjectId = id;
    document.getElementById('deleteProjectName').textContent = title;
    document.getElementById('deleteModal').classList.remove('hidden');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
    document.getElementById('deleteReason').value = '';
    currentProjectId = null;
}

function confirmDelete() {
    const reason = document.getElementById('deleteReason').value;
    fetch(`/projects/${currentProjectId}/delete`, {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: new URLSearchParams({reason: reason})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert('✅ Project deleted successfully');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to delete'));
        }
    })
    .catch(err => {
        alert('Error deleting project');
        console.error(err);
    });
}

function leaveProject(id, title) {
    currentProjectId = id;
    document.getElementById('leaveProjectName').textContent = title;
    document.getElementById('leaveModal').classList.remove('hidden');
}

function closeLeaveModal() {
    document.getElementById('leaveModal').classList.add('hidden');
    document.getElementById('leaveReason').value = '';
    currentProjectId = null;
}

function confirmLeave() {
    const reason = document.getElementById('leaveReason').value;
    fetch(`/projects/${currentProjectId}/leave`, {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: new URLSearchParams({reason: reason})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert('👋 You have left this project');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to leave'));
        }
    })
    .catch(err => {
        alert('Error leaving project');
        console.error(err);
    });
}

</script>


<!-- Delete Project Modal -->
<div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
        <h3 class="text-xl font-bold mb-4">🗑️ Delete Project?</h3>
        <p class="text-gray-600 mb-4">Are you sure you want to delete <strong id="deleteProjectName"></strong>?</p>
        <input type="text" id="deleteReason" placeholder="Reason for deletion (optional)" 
               class="w-full px-4 py-2 border rounded mb-4">
        <div class="flex gap-3">
            <button onclick="closeDeleteModal()" class="flex-1 px-4 py-2 border rounded hover:bg-gray-50">Cancel</button>
            <button onclick="confirmDelete()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
        </div>
    </div>
</div>

<!-- Leave Project Modal -->
<div id="leaveModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
        <h3 class="text-xl font-bold mb-4">👋 Leave Project?</h3>
        <p class="text-gray-600 mb-4">Customer will be notified. Project: <strong id="leaveProjectName"></strong></p>
        <input type="text" id="leaveReason" placeholder="Reason for leaving (optional)" 
               class="w-full px-4 py-2 border rounded mb-4">
        <div class="flex gap-3">
            <button onclick="closeLeaveModal()" class="flex-1 px-4 py-2 border rounded hover:bg-gray-50">Cancel</button>
            <button onclick="confirmLeave()" class="flex-1 px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700">Leave</button>
        </div>
    </div>
</div>


<!-- Dispute Modal -->
<div id="disputeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
        <h3 class="text-xl font-bold mb-4">⚠️ Raise Dispute</h3>
        <form id="disputeForm">
            <div class="mb-4">
                <label class="block text-sm font-semibold mb-2">Dispute Type</label>
                <select id="disputeType" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500" required>
                    <option value="">Select type...</option>
                    <option value="payment_not_received">Payment Not Received</option>
                    <option value="wrong_amount">Wrong Amount</option>
                    <option value="quality_issue">Quality Issue</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-semibold mb-2">Description</label>
                <textarea id="disputeDescription" 
                          rows="4" 
                          placeholder="Describe the issue in detail..." 
                          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500" 
                          required></textarea>
            </div>
            <div class="bg-yellow-50 border border-yellow-200 rounded p-3 mb-4">
                <p class="text-xs text-yellow-800">
                    <i class="fas fa-info-circle mr-1"></i>
                    Admin will review this dispute and contact both parties. Please provide accurate details.
                </p>
            </div>
            <div class="flex gap-3">
                <button type="button" onclick="closeDisputeModal()" 
                        class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                <button type="submit" 
                        class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Submit Dispute</button>
            </div>
        </form>
    </div>
</div>

<script>
let currentDisputeTransactionId = null;

function openDisputeModal(transactionId) {
    currentDisputeTransactionId = transactionId;
    document.getElementById('disputeModal').classList.remove('hidden');
}

function closeDisputeModal() {
    document.getElementById('disputeModal').classList.add('hidden');
    document.getElementById('disputeForm').reset();
    currentDisputeTransactionId = null;
}

document.getElementById('disputeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const type = document.getElementById('disputeType').value;
    const description = document.getElementById('disputeDescription').value;
    
    if (!type || !description) {
        alert('Please fill all fields');
        return;
    }
    
    fetch(`/dispute/create/${currentDisputeTransactionId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: new URLSearchParams({type: type, description: description})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert('⚠️ Dispute raised successfully. Admin will review.');
            closeDisputeModal();
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to raise dispute'));
        }
    })
    .catch(err => {
        alert('Error raising dispute');
        console.error(err);
    });
});
</script>

{% endblock %}