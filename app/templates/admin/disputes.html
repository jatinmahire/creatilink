{% extends "admin/base.html" %}
{% block title %}Dispute Resolution{% endblock %}
{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex justify-between items-center">
        <h2 class="text-3xl font-bold text-gray-800">
            <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
            Dispute Resolution Center
        </h2>
    </div>

    <!--Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl shadow-lg p-6 text-white">
            <div class="text-sm opacity-90 mb-1">Open Disputes</div>
            <div class="text-4xl font-bold">{{ total_open }}</div>
            <div class="text-xs mt-2 opacity-75">Needs immediate attention</div>
        </div>

        <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-lg p-6 text-white">
            <div class="text-sm opacity-90 mb-1">Old Disputes</div>
            <div class="text-4xl font-bold">{{ old_disputes }}</div>
            <div class="text-xs mt-2 opacity-75">&gt;48 hours old ⚠️</div>
        </div>

        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
            <div class="text-sm opacity-90 mb-1">Resolved</div>
            <div class="text-4xl font-bold">{{ total_resolved }}</div>
            <div class="text-xs mt-2 opacity-75">Successfully closed</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <form method="GET" class="flex gap-4">
            <div class="flex-1">
                <label class="block text-sm font-semibold mb-2">Filter by Status</label>
                <select name="status" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500">
                    <option value="">All Disputes</option>
                    <option value="open" {% if request.args.get('status')=='open' %}selected{% endif %}>Open</option>
                    <option value="resolved" {% if request.args.get('status')=='resolved' %}selected{% endif %}>Resolved
                    </option>
                </select>
            </div>
            <div class="flex items-end space-x-2">
                <button type="submit" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">
                    <i class="fas fa-filter mr-2"></i>Filter
                </button>
                <a href="{{ url_for('admin.disputes') }}"
                    class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-300">
                    <i class="fas fa-times mr-2"></i>Clear
                </a>
            </div>
        </form>
    </div>

    <!-- Disputes Table -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 border-b">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">ID</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Project</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Type</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Raised By</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Amount</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Age</th>
                        <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for dispute in disputes.items %}
                    {% set age_hours = ((now() - dispute.created_at).total_seconds() / 3600) | int %}
                    <tr
                        class="hover:bg-gray-50 {% if dispute.status == 'open' and age_hours > 48 %}bg-red-50{% endif %}">
                        <td class="px-6 py-4 text-sm text-gray-600">#{{ dispute.id }}</td>
                        <td class="px-6 py-4">
                            <div class="font-semibold text-gray-900">{{ dispute.transaction.project.title[:30] }}...
                            </div>
                            <div class="text-xs text-gray-500">Txn #{{ dispute.transaction.id }}</div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="text-sm font-medium text-gray-700">{{ dispute.dispute_type|title }}</span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm">{{ dispute.raised_by.full_name }}</div>
                            <div class="text-xs text-gray-500">{{ dispute.raised_by.role|title }}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="font-bold text-lg text-red-600">₹{{ dispute.transaction.amount }}</div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold
                                         bg-{{ 'red' if dispute.status == 'open' else 'green' }}-100 
                                         text-{{ 'red' if dispute.status == 'open' else 'green' }}-700">
                                <i class="fas fa-circle text-xs mr-1"></i>
                                {{ dispute.status|title }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm">
                            {% if age_hours < 24 %} <span class="text-green-600">{{ age_hours }}h</span>
                                {% elif age_hours < 48 %} <span class="text-yellow-600">{{ age_hours }}h</span>
                                    {% else %}
                                    <span class="text-red-600 font-bold">{{ age_hours }}h ⚠️</span>
                                    {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex justify-center space-x-2">
                                <!-- View Details -->
                                <button onclick="viewDisputeDetails({{ dispute.id }})"
                                    class="text-blue-600 hover:text-blue-800" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>

                                {% if dispute.status == 'open' %}
                                <!-- Resolve -->
                                <button onclick="resolveDispute({{ dispute.id }})"
                                    class="text-green-600 hover:text-green-800" title="Resolve Dispute">
                                    <i class="fas fa-check"></i>
                                </button>

                                <!-- Refund -->
                                <button onclick="refundDispute({{ dispute.id }}, {{ dispute.transaction.amount }})"
                                    class="text-red-600 hover:text-red-800" title="Refund & Resolve">
                                    <i class="fas fa-undo"></i>
                                </button>

                                <!-- Release Payment -->
                                <button onclick="releaseDispute({{ dispute.id }}, {{ dispute.transaction.amount }})"
                                    class="text-purple-600 hover:text-purple-800" title="Release Payment & Resolve">
                                    <i class="fas fa-unlock"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4 opacity-50"></i>
                            <p>No disputes found</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    {% if disputes.pages > 1 %}
    <div class="flex justify-center space-x-2">
        {% if disputes.has_prev %}
        <a href="{{ url_for('admin.disputes', page=disputes.prev_num, status=request.args.get('status')) }}"
            class="px-4 py-2 bg-white border rounded-lg hover:bg-gray-50">
            <i class="fas fa-chevron-left"></i>
        </a>
        {% endif %}

        <span class="px-4 py-2 bg-red-600 text-white rounded-lg">
            Page {{ disputes.page }} of {{ disputes.pages }}
        </span>

        {% if disputes.has_next %}
        <a href="{{ url_for('admin.disputes', page=disputes.next_num, status=request.args.get('status')) }}"
            class="px-4 py-2 bg-white border rounded-lg hover:bg-gray-50">
            <i class="fas fa-chevron-right"></i>
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Dispute Details Modal -->
<div id="disputeDetailsModal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
        <div
            class="sticky top-0 bg-gradient-to-r from-red-600 to-red-700 text-white px-6 py-4 flex justify-between items-center">
            <h3 class="text-xl font-bold"><i class="fas fa-exclamation-triangle mr-2"></i>Dispute Details</h3>
            <button onclick="closeDisputeDetails()" class="text-white hover:text-gray-200">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>

        <div id="disputeDetailsContent" class="p-6">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>
</div>

<!-- Resolve Modal -->
<div id="resolveModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
        <h3 class="text-xl font-bold mb-4 text-green-600"><i class="fas fa-check-circle mr-2"></i>Resolve Dispute</h3>
        <textarea id="resolveNotes" placeholder="Resolution notes (required)"
            class="w-full px-4 py-2 border rounded mb-4 h-24"></textarea>
        <div class="flex gap-3">
            <button onclick="closeResolveModal()"
                class="flex-1 px-4 py-2 border rounded hover:bg-gray-50">Cancel</button>
            <button onclick="confirmResolve()"
                class="flex-1 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Resolve</button>
        </div>
    </div>
</div>

<!-- Refund Modal -->
<div id="refundDisputeModal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
        <h3 class="text-xl font-bold mb-4 text-red-600"><i class="fas fa-undo mr-2"></i>Refund & Resolve</h3>
        <p class="text-gray-600 mb-4">Refund amount: <strong id="refundDisputeAmount"></strong></p>
        <textarea id="refundDisputeNotes" placeholder="Refund reason (optional)"
            class="w-full px-4 py-2 border rounded mb-4 h-20"></textarea>
        <div class="flex gap-3">
            <button onclick="closeRefundDisputeModal()"
                class="flex-1 px-4 py-2 border rounded hover:bg-gray-50">Cancel</button>
            <button onclick="confirmRefundDispute()"
                class="flex-1 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Refund</button>
        </div>
    </div>
</div>

<!-- Release Modal -->
<div id="releaseDisputeModal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
        <h3 class="text-xl font-bold mb-4 text-purple-600"><i class="fas fa-unlock mr-2"></i>Release Payment & Resolve
        </h3>
        <p class="textgray-600 mb-4">Release amount: <strong id="releaseDisputeAmount"></strong></p>
        <textarea id="releaseDisputeNotes" placeholder="Release reason (optional)"
            class="w-full px-4 py-2 border rounded mb-4 h-20"></textarea>
        <div class="flex gap-3">
            <button onclick="closeReleaseDisputeModal()"
                class="flex-1 px-4 py-2 border rounded hover:bg-gray-50">Cancel</button>
            <button onclick="confirmReleaseDispute()"
                class="flex-1 px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">Release</button>
        </div>
    </div>
</div>

<script>
    let currentDisputeId = null;

    // View Dispute Details
    async function viewDisputeDetails(disputeId) {
        try {
            const res = await fetch(`/admin/disputes/${disputeId}/details`);
            const data = await res.json();

            if (data.success) {
                const d = data.dispute;
                const project = data.project;
                const txn = data.transaction;
                const raisedBy = data.raised_by;
                const customer = data.customer;
                const creator = data.creator;

                const html = `
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-red-50 p-4 rounded-lg">
                            <div class="text-sm text-gray-600 mb-1">Dispute ID</div>
                            <div class="text-2xl font-bold text-red-600">#${d.id}</div>
                            <div class="text-xs mt-2 ${d.age_hours > 48 ? 'text-red-600 font-bold' : 'text-gray-600'}">
                                Age: ${d.age_hours} hours ${d.age_hours > 48 ? '⚠️' : ''}
                            </div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <div class="text-sm text-gray-600 mb-1">Amount</div>
                            <div class="text-2xl font-bold text-purple-600">₹${txn.amount}</div>
                            <div class="text-xs mt-2 text-gray-600">Transaction #${txn.id}</div>
                        </div>
                    </div>
                    
                    <div>
                        <h5 class="font-semibold mb-2">Dispute Information</h5>
                        <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                            <div><span class="font-medium">Type:</span> ${d.type}</div>
                            <div><span class="font-medium">Status:</span> 
                                <span class="px-2 py-1 rounded text-xs ${d.status === 'open' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                                    ${d.status}
                                </span>
                            </div>
                            <div><span class="font-medium">Created:</span> ${d.created_at}</div>
                            ${d.resolved_at ? `<div><span class="font-medium">Resolved:</span> ${d.resolved_at}</div>` : ''}
                        </div>
                    </div>
                    
                    <div>
                        <h5 class="font-semibold mb-2">Description</h5>
                        <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                            <p class="text-gray-700">${d.description}</p>
                        </div>
                    </div>
                    
                    ${d.resolution_notes ? `
                        <div>
                            <h5 class="font-semibold mb-2">Resolution Notes</h5>
                            <div class="bg-green-50 border border-green-200 p-4 rounded-lg">
                                <p class="text-gray-700">${d.resolution_notes}</p>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div>
                        <h5 class="font-semibold mb-2">Project</h5>
                        <div class="bg-blue-50 p-3 rounded-lg">
                            <div class="font-medium">${project.title}</div>
                            <div class="text-sm text-gray-600">Status: ${project.status}</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <h5 class="font-semibold mb-2">Customer</h5>
                            <div class="bg-blue-50 p-3 rounded-lg">
                                <div class="font-medium">${customer.name}</div>
                                <div class="text-sm text-gray-600">${customer.email}</div>
                                ${raisedBy.role === 'customer' ? '<div class="text-xs mt-2 text-red-600">⚠️ Raised this dispute</div>' : ''}
                            </div>
                        </div>
                        <div>
                            <h5 class="font-semibold mb-2">Creator</h5>
                            <div class="bg-green-50 p-3 rounded-lg">
                                <div class="font-medium">${creator.name}</div>
                                <div class="text-sm text-gray-600">${creator.email}</div>
                                ${raisedBy.role === 'creator' ? '<div class="text-xs mt-2 text-red-600">⚠️ Raised this dispute</div>' : ''}
                            </div>
                        </div>
                    </div>
                    
                    ${d.status === 'open' ? `
                        <div class="border-t pt-4 mt-4">
                            <h5 class="font-semibold mb-3">Quick Actions</h5>
                            <div class="flex gap-2">
                                <button onclick="banUserFromDispute(${d.id}, ${customer.id}, '${customer.name}')" 
                                        class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                                    Ban Customer
                                </button>
                                <button onclick="banUserFromDispute(${d.id}, ${creator.id}, '${creator.name}')" 
                                        class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                                    Ban Creator
                                </button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

                document.getElementById('disputeDetailsContent').innerHTML = html;
                document.getElementById('disputeDetailsModal').classList.remove('hidden');
            }
        } catch (error) {
            alert('Error loading dispute details');
        }
    }

    function closeDisputeDetails() {
        document.getElementById('disputeDetailsModal').classList.add('hidden');
    }

    // Resolve Dispute
    function resolveDispute(disputeId) {
        currentDisputeId = disputeId;
        document.getElementById('resolveModal').classList.remove('hidden');
    }

    function closeResolveModal() {
        document.getElementById('resolveModal').classList.add('hidden');
        document.getElementById('resolveNotes').value = '';
        currentDisputeId = null;
    }

    async function confirmResolve() {
        const notes = document.getElementById('resolveNotes').value;
        if (!notes) {
            alert('Please provide resolution notes');
            return;
        }

        const formData = new FormData();
        formData.append('notes', notes);

        try {
            const res = await fetch(`/admin/disputes/${currentDisputeId}/resolve`, {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if (data.success) {
                closeResolveModal();
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Failed to resolve'));
            }
        } catch (error) {
            alert('Error resolving dispute');
        }
    }

    // Refund Dispute
    function refundDispute(disputeId, amount) {
        currentDisputeId = disputeId;
        document.getElementById('refundDisputeAmount').textContent = `₹${amount}`;
        document.getElementById('refundDisputeModal').classList.remove('hidden');
    }

    function closeRefundDisputeModal() {
        document.getElementById('refundDisputeModal').classList.add('hidden');
        document.getElementById('refundDisputeNotes').value = '';
        currentDisputeId = null;
    }

    async function confirmRefundDispute() {
        const notes = document.getElementById('refundDisputeNotes').value;

        const formData = new FormData();
        formData.append('notes', notes);

        try {
            const res = await fetch(`/admin/disputes/${currentDisputeId}/refund`, {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if (data.success) {
                closeRefundDisputeModal();
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Failed to refund'));
            }
        } catch (error) {
            alert('Error refunding');
        }
    }

    // Release Payment
    function releaseDispute(disputeId, amount) {
        currentDisputeId = disputeId;
        document.getElementById('releaseDisputeAmount').textContent = `₹${amount}`;
        document.getElementById('releaseDisputeModal').classList.remove('hidden');
    }

    function closeReleaseDisputeModal() {
        document.getElementById('releaseDisputeModal').classList.add('hidden');
        document.getElementById('releaseDisputeNotes').value = '';
        currentDisputeId = null;
    }

    async function confirmReleaseDispute() {
        const notes = document.getElementById('releaseDisputeNotes').value;

        const formData = new FormData();
        formData.append('notes', notes);

        try {
            const res = await fetch(`/admin/disputes/${currentDisputeId}/release`, {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if (data.success) {
                closeReleaseDisputeModal();
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Failed to release'));
            }
        } catch (error) {
            alert('Error releasing payment');
        }
    }

    // Ban User from Dispute
    async function banUserFromDispute(disputeId, userId, userName) {
        if (!confirm(`Ban ${userName}? This will:\n• Ban the user permanently\n• Resolve the dispute\n\nContinue?`)) {
            return;
        }

        const reason = prompt('Ban reason (optional):');
        const formData = new FormData();
        if (reason) formData.append('reason', reason);

        try {
            const res = await fetch(`/admin/disputes/${disputeId}/ban-user/${userId}`, {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Failed to ban user'));
            }
        } catch (error) {
            alert('Error banning user');
        }
    }
</script>
{% endblock %}